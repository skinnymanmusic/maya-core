# Maya Backend - Runtime Assumptions Report

Generated by Full Repo Audit & Repair process

## Python Version

**Target Runtime:** Python 3.11.x (specifically 3.11.9)

### Configuration Files Status

| File | Python Version | Status |
|------|---------------|---------|
| `runtime.txt` | python-3.11.9 | ‚úÖ Correct |
| `.python-version` | 3.11.9 | ‚úÖ Correct |
| `nixpacks.toml` | python311 | ‚úÖ Correct |
| `railway.json` | python311 | ‚úÖ Correct |

**Consistency:** ‚úÖ All configuration files consistently target Python 3.11.x

### Critical Dependency Compatibility

#### asyncpg (0.29.0)
- **Status:** ‚úÖ Compatible with Python 3.11
- **Note:** Does NOT compile on Python 3.13 (as documented in nixpacks.toml)
- **Requirement:** MUST use Python 3.11.x

#### Key Dependencies Python 3.11 Compatibility Check

| Dependency | Version | Python 3.11 Compatible |
|-----------|---------|----------------------|
| fastapi | 0.115.0 | ‚úÖ Yes |
| uvicorn | 0.32.0 | ‚úÖ Yes |
| pydantic | 2.9.2 | ‚úÖ Yes |
| asyncpg | 0.29.0 | ‚úÖ Yes (REQUIRES 3.11) |
| sqlalchemy | 2.0.36 | ‚úÖ Yes |
| psycopg2-binary | 2.9.10 | ‚úÖ Yes |
| anthropic | 0.39.0 | ‚úÖ Yes |
| stripe | 7.8.0 | ‚úÖ Yes |
| twilio | 8.10.0 | ‚úÖ Yes |

### Start Command Consistency

**Nixpacks:**
```bash
/opt/venv/bin/python -m uvicorn app.main:app --host 0.0.0.0 --port $PORT
```

**Railway:**
```bash
python3.11 -m uvicorn app.main:app --host 0.0.0.0 --port $PORT
```

**Status:** ‚úÖ Both target the correct module path `app.main:app`

## Deployment Platform

**Primary Platform:** Railway
**Build System:** Nixpacks
**Configuration Method:** Declarative (nixpacks.toml + railway.json)

### Build Process

1. **Setup Phase:**
   - Installs Python 3.11 packages
   - Installs PostgreSQL client libraries
   - Sets up system libraries (zlib, libffi, openssl)

2. **Install Phase:**
   - Creates virtual environment at `/opt/venv`
   - Upgrades pip
   - Installs all requirements from `requirements.txt`

3. **Start Phase:**
   - Runs uvicorn server
   - Binds to all interfaces (0.0.0.0)
   - Uses dynamic port from $PORT environment variable

### Environment Variables Required

Based on `app/config.py` analysis, the following environment variables are REQUIRED:

**Critical (will cause startup failure if missing):**
- `DATABASE_URL` - PostgreSQL connection string
- `JWT_SECRET_KEY` - JWT signing key
- `ENCRYPTION_KEY` - Data encryption key (32 bytes base64)
- `GMAIL_WEBHOOK_URL` - Gmail webhook endpoint
- `GMAIL_PUBSUB_TOPIC` - Google Pub/Sub topic
- `GMAIL_PUBSUB_SERVICE_ACCOUNT` - Service account JSON

**Optional (have defaults):**
- `HOST` - Default: 0.0.0.0
- `PORT` - Default: 8000 (overridden by Railway)
- `ENVIRONMENT` - Default: development
- `DEFAULT_TENANT_ID` - Default: default

## Runtime Safety Checks

### Protected Areas (DO NOT MODIFY)
The following files are protected under Gilman Accords:
- ‚ùå `app/core/security.py` - Does NOT exist (OK)
- ‚ùå `app/core/encryption.py` - Does NOT exist (using `app/encryption.py` instead)
- ‚ùå `app/core/auth.py` - Does NOT exist (using `app/routers/auth.py` instead)
- ‚úÖ `app/guardians/**` - EXISTS, protected
- ‚úÖ Payment-related services - EXISTS, protected

**Note:** Core security functions are currently in:
- `app/encryption.py` - Encryption/decryption (PROTECTED)
- `app/middleware/security.py` - Security middleware (PROTECTED)
- `app/routers/auth.py` - Authentication endpoints (REVIEW CAREFULLY)
- `app/services/auth_service.py` - Auth business logic (REVIEW CAREFULLY)

### Database Migrations
- ‚úÖ `backend/app/db/migrations/**` - Path does NOT exist
- ‚ÑπÔ∏è Migrations appear to be in `backend/migrations/` (root level)
- **Status:** NO SCHEMA CHANGES ALLOWED per policy

## Recommendations

### ‚úÖ Safe to Deploy
- Python 3.11 compatibility: Verified
- All runtime configs aligned: Verified
- Critical dependencies compatible: Verified
- Start command correct: Verified

### ‚ö†Ô∏è Must Resolve Before Deploy
Based on REPORT_IMPORT_ISSUES.md:
- 16 import issues detected
- Most critical: Missing router exports in `app/routers/__init__.py`
- Missing: `get_async_session` function in `app/database.py`
- Missing: `get_encryption_service` from `app/services/encryption`

### üîí Security Review Required
If any changes touch:
- `app/encryption.py`
- `app/middleware/security.py`
- `app/services/auth_service.py`
- Any guardian files

Then MUST have `approved-core-change` label before merge.

## Next Steps

1. ‚úÖ Phase 1 Complete - Runtime assumptions verified
2. ‚û°Ô∏è Phase 2 - Fix all import breakages (16 issues)
3. ‚è≠Ô∏è Phase 3 - Dependency alignment
4. ‚è≠Ô∏è Phase 4 - Static health check
5. ‚è≠Ô∏è Phase 5 - Prepare git branch for review

---
*Generated: 2025-11-22*
*Agent: Solin/Claude in Full Repo Audit & Repair mode*
